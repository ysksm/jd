<div class="projects">
  <div class="page-header">
    <h2>Projects</h2>
    <div class="fetch-controls">
      @if (hasMultipleEndpoints()) {
        <button
          class="btn btn-secondary"
          (click)="showFetchOptions.set(!showFetchOptions())"
          [disabled]="syncing()"
        >
          Options
        </button>
      }
      <button class="btn btn-primary" (click)="initializeProjects()" [disabled]="syncing()">
        {{ syncing() ? 'Fetching...' : 'Fetch from JIRA' }}
      </button>
    </div>
  </div>

  @if (hasMultipleEndpoints() && showFetchOptions()) {
    <div class="fetch-options">
      <label>Fetch from:</label>
      <select
        [ngModel]="selectedFetchEndpoint()"
        (ngModelChange)="selectedFetchEndpoint.set($event)"
      >
        <option value="active">Active Endpoint ({{ activeEndpoint() }})</option>
        <option value="all">All Endpoints</option>
        @for (ep of endpoints(); track ep.name) {
          <option [value]="ep.name">{{ getEndpointDisplayName(ep) }}</option>
        }
      </select>
    </div>
  }

  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  @if (success()) {
    <div class="alert alert-success">{{ success() }}</div>
  }

  @if (lastFetchResults()) {
    <div class="fetch-results">
      <h4>Fetch Results:</h4>
      <ul>
        @for (result of lastFetchResults(); track result.endpointName) {
          <li [class.success]="result.success" [class.error]="!result.success">
            <strong>{{ result.endpointName }}:</strong>
            @if (result.success) {
              {{ result.projectCount }} projects
            } @else {
              Failed - {{ result.error }}
            }
          </li>
        }
      </ul>
    </div>
  }

  @if (loading()) {
    <div class="loading">Loading projects...</div>
  } @else {
    <div class="stats">
      <span class="stat">{{ enabledCount }} enabled</span>
      <span class="separator">/</span>
      <span class="stat">{{ totalCount }} total</span>
    </div>

    @if (projects().length === 0) {
      <div class="empty-state">
        <p>No projects found.</p>
        <p>Click "Fetch from JIRA" to get your project list.</p>
      </div>
    } @else {
      <div class="project-list">
        @for (project of projects(); track project.key) {
          <div class="project-card" [class.enabled]="project.enabled" [class.clickable]="project.enabled" (click)="project.enabled && goToProject(project.key)">
            <div class="project-info">
              <div class="project-key">{{ project.key }}</div>
              <div class="project-name">{{ project.name }}</div>
              @if (project.lastSyncedAt) {
                <div class="project-synced">Last synced: {{ project.lastSyncedAt }}</div>
              }
            </div>
            <div class="project-actions">
              @if (project.enabled) {
                <button class="btn btn-secondary" (click)="disableProject(project.key); $event.stopPropagation()">
                  Disable
                </button>
                <button class="btn btn-primary" (click)="goToProject(project.key); $event.stopPropagation()">
                  Open
                </button>
              } @else {
                <button class="btn btn-primary" (click)="enableProject(project.key); $event.stopPropagation()">
                  Enable
                </button>
              }
            </div>
          </div>
        }
      </div>
    }
  }
</div>
