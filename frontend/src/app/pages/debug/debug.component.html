<div class="debug-page">
  <h1>Debug Tools</h1>

  <!-- Status Banner -->
  @if (loading()) {
    <div class="status-banner loading">Loading...</div>
  } @else if (!debugEnabled()) {
    <div class="status-banner disabled">
      <strong>Debug Mode Disabled</strong>
      <p>{{ statusMessage() }}</p>
    </div>
  } @else {
    <div class="status-banner enabled">
      <strong>Debug Mode Enabled</strong>
      <p>{{ statusMessage() }}</p>
    </div>
  }

  <!-- Messages -->
  @if (error()) {
    <div class="message error" (click)="clearMessages()">
      <span class="icon">✕</span>
      {{ error() }}
    </div>
  }
  @if (success()) {
    <div class="message success" (click)="clearMessages()">
      <span class="icon">✓</span>
      {{ success() }}
    </div>
  }

  @if (debugEnabled()) {
    <!-- AI Test Data Generation Section -->
    <section class="card ai-section">
      <h2>AI Test Data Generation (Claude)</h2>
      <p class="description">Use Claude AI to generate realistic test data with hierarchical structure and time-series for burndown charts.</p>

      <!-- AI Status -->
      <div class="ai-status" [class.configured]="aiConfigured()" [class.not-configured]="!aiConfigured()">
        @if (aiLoadingStatus()) {
          <span>Checking AI configuration...</span>
        } @else {
          <span>{{ aiStatusMessage() }}</span>
        }
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="aiProject">Project</label>
          <select
            id="aiProject"
            [ngModel]="selectedProject()"
            (ngModelChange)="onProjectChange($event)"
          >
            @for (project of projects(); track project.key) {
              <option [value]="project.key">{{ project.key }} - {{ project.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="aiMode">Generation Mode</label>
          <select
            id="aiMode"
            [ngModel]="aiMode()"
            (ngModelChange)="onAiModeChange($event)"
          >
            <option value="sprint">Sprint (Epic + Stories + Tasks + Bugs)</option>
            <option value="epic">Epic Only (Epic + Stories)</option>
            <option value="bugs">Bugs Only</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label for="aiContext">Project Context (for AI)</label>
          <textarea
            id="aiContext"
            rows="2"
            placeholder="Describe your project for more realistic test data..."
            [ngModel]="aiProjectContext()"
            (ngModelChange)="aiProjectContext.set($event)"
          ></textarea>
        </div>

        @if (aiMode() === 'sprint') {
          <div class="form-group">
            <label for="aiTeamSize">Team Size</label>
            <input
              type="number"
              id="aiTeamSize"
              min="1"
              max="20"
              [ngModel]="aiTeamSize()"
              (ngModelChange)="aiTeamSize.set($event)"
            />
          </div>

          <div class="form-group">
            <label for="aiSprintDuration">Sprint Duration (days)</label>
            <input
              type="number"
              id="aiSprintDuration"
              min="7"
              max="30"
              [ngModel]="aiSprintDuration()"
              (ngModelChange)="aiSprintDuration.set($event)"
            />
          </div>
        }

        @if (aiMode() === 'epic') {
          <div class="form-group full-width">
            <label for="aiEpicTheme">Epic Theme</label>
            <input
              type="text"
              id="aiEpicTheme"
              placeholder="e.g., User Authentication, Payment Integration"
              [ngModel]="aiEpicTheme()"
              (ngModelChange)="aiEpicTheme.set($event)"
            />
          </div>
        }

        @if (aiMode() === 'bugs') {
          <div class="form-group">
            <label for="aiBugCount">Number of Bugs</label>
            <input
              type="number"
              id="aiBugCount"
              min="1"
              max="20"
              [ngModel]="aiBugCount()"
              (ngModelChange)="aiBugCount.set($event)"
            />
          </div>
        }

        <div class="form-group checkbox-group">
          <label>
            <input
              type="checkbox"
              [ngModel]="aiApplyTransitions()"
              (ngModelChange)="aiApplyTransitions.set($event)"
            />
            Apply status transitions (simulate progress)
          </label>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input
              type="checkbox"
              [ngModel]="aiUseFastModel()"
              (ngModelChange)="aiUseFastModel.set($event)"
              [disabled]="aiUseClaudeCli()"
            />
            Use fast model (Haiku - cheaper/faster)
          </label>
        </div>

        @if (aiCliAvailable()) {
          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [ngModel]="aiUseClaudeCli()"
                (ngModelChange)="aiUseClaudeCli.set($event)"
              />
              Use Claude CLI (uses your Claude Code subscription)
            </label>
          </div>
        }
      </div>

      <button
        class="btn primary ai-btn"
        [disabled]="aiGenerating() || !selectedProject() || !aiConfigured()"
        (click)="generateAiTestData()"
      >
        @if (aiGenerating()) {
          <span class="spinner"></span>
          Generating with AI...
        } @else {
          Generate Test Data with Claude
        }
      </button>

      @if (aiStats()) {
        <div class="ai-results">
          <h4>Generation Results</h4>
          <div class="stats-grid">
            <div class="stat">
              <span class="label">Total Generated</span>
              <span class="value">{{ aiStats()!.totalGenerated }}</span>
            </div>
            <div class="stat success">
              <span class="label">Created</span>
              <span class="value">{{ aiStats()!.successfullyCreated }}</span>
            </div>
            <div class="stat" [class.error]="aiStats()!.failedToCreate > 0">
              <span class="label">Failed</span>
              <span class="value">{{ aiStats()!.failedToCreate }}</span>
            </div>
            <div class="stat">
              <span class="label">Epics</span>
              <span class="value">{{ aiStats()!.epicsCreated }}</span>
            </div>
            <div class="stat">
              <span class="label">Stories</span>
              <span class="value">{{ aiStats()!.storiesCreated }}</span>
            </div>
            <div class="stat">
              <span class="label">Tasks</span>
              <span class="value">{{ aiStats()!.tasksCreated }}</span>
            </div>
            <div class="stat">
              <span class="label">Bugs</span>
              <span class="value">{{ aiStats()!.bugsCreated }}</span>
            </div>
            <div class="stat">
              <span class="label">Transitions</span>
              <span class="value">{{ aiStats()!.transitionsApplied }}</span>
            </div>
            <div class="stat">
              <span class="label">Links</span>
              <span class="value">{{ aiStats()!.linksCreated }}</span>
            </div>
            <div class="stat">
              <span class="label">Due Dates</span>
              <span class="value">{{ aiStats()!.dueDatesSet }}</span>
            </div>
          </div>
        </div>
      }

      @if (aiCreatedIssues().length > 0) {
        <div class="results">
          <h4>Created Issues ({{ aiCreatedIssues().length }})</h4>
          <table class="results-table">
            <thead>
              <tr>
                <th>Key</th>
                <th>Type</th>
                <th>Summary</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              @for (issue of aiCreatedIssues(); track issue.key) {
                <tr>
                  <td>
                    @if (issue.selfUrl) {
                      <a [href]="issue.selfUrl" target="_blank">{{ issue.key }}</a>
                    } @else {
                      {{ issue.key }}
                    }
                  </td>
                  <td>{{ issue.issueType }}</td>
                  <td class="summary">{{ issue.summary }}</td>
                  <td>{{ issue.status }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      @if (aiFailedIssues().length > 0) {
        <div class="results error-results">
          <h4>Failed Issues ({{ aiFailedIssues().length }})</h4>
          <table class="results-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Summary</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody>
              @for (issue of aiFailedIssues(); track issue.summary) {
                <tr class="error">
                  <td>{{ issue.issueType }}</td>
                  <td class="summary">{{ issue.summary }}</td>
                  <td class="error-msg">{{ issue.error }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </section>

    <!-- Create Issues Section -->
    <section class="card">
      <h2>Create Test Issues (Manual)</h2>
      <p class="description">Create simple test issues in JIRA for debugging purposes.</p>

      <div class="form-grid">
        <div class="form-group">
          <label for="project">Project</label>
          <select
            id="project"
            [ngModel]="selectedProject()"
            (ngModelChange)="onProjectChange($event)"
          >
            @for (project of projects(); track project.key) {
              <option [value]="project.key">{{ project.key }} - {{ project.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="issueType">Issue Type</label>
          <select
            id="issueType"
            [ngModel]="issueType()"
            (ngModelChange)="issueType.set($event)"
            [disabled]="loadingIssueTypes()"
          >
            @if (loadingIssueTypes()) {
              <option value="">Loading...</option>
            } @else {
              @for (type of issueTypes(); track type.name) {
                <option [value]="type.name">{{ type.name }}</option>
              }
            }
          </select>
        </div>

        <div class="form-group">
          <label for="count">Count</label>
          <input
            type="number"
            id="count"
            min="1"
            max="100"
            [ngModel]="issueCount()"
            (ngModelChange)="issueCount.set($event)"
          />
        </div>

        <div class="form-group full-width">
          <label for="summary">Summary</label>
          <input
            type="text"
            id="summary"
            [ngModel]="summary()"
            (ngModelChange)="summary.set($event)"
          />
        </div>

        <div class="form-group full-width">
          <label for="description">Description (optional)</label>
          <textarea
            id="description"
            rows="3"
            [ngModel]="description()"
            (ngModelChange)="description.set($event)"
          ></textarea>
        </div>
      </div>

      <button
        class="btn primary"
        [disabled]="creatingIssues() || !selectedProject()"
        (click)="createIssues()"
      >
        @if (creatingIssues()) {
          Creating...
        } @else {
          Create {{ issueCount() }} Issue(s)
        }
      </button>

      @if (createdIssues().length > 0) {
        <div class="results">
          <h4>Created Issues:</h4>
          <ul>
            @for (issue of createdIssues(); track issue.key) {
              <li>
                <a [href]="issue.selfUrl" target="_blank">{{ issue.key }}</a>
              </li>
            }
          </ul>
        </div>
      }
    </section>

    <!-- Transition Issue Section -->
    <section class="card">
      <h2>Transition Issue</h2>
      <p class="description">Change the status of an issue by applying a transition.</p>

      <div class="form-row">
        <div class="form-group">
          <label for="transitionIssueKey">Issue Key</label>
          <input
            type="text"
            id="transitionIssueKey"
            placeholder="e.g., PROJ-123"
            [ngModel]="transitionIssueKey()"
            (ngModelChange)="transitionIssueKey.set($event)"
          />
        </div>
        <button
          class="btn secondary"
          [disabled]="loadingTransitions() || !transitionIssueKey()"
          (click)="loadTransitions()"
        >
          @if (loadingTransitions()) {
            Loading...
          } @else {
            Load Transitions
          }
        </button>
      </div>

      @if (transitions().length > 0) {
        <div class="form-row">
          <div class="form-group">
            <label for="transition">Available Transitions</label>
            <select
              id="transition"
              [ngModel]="selectedTransition()"
              (ngModelChange)="selectedTransition.set($event)"
            >
              @for (t of transitions(); track t.id) {
                <option [value]="t.id">{{ t.name }} → {{ t.toStatus }}</option>
              }
            </select>
          </div>
          <button
            class="btn primary"
            [disabled]="transitioning() || !selectedTransition()"
            (click)="transitionIssue()"
          >
            @if (transitioning()) {
              Transitioning...
            } @else {
              Apply Transition
            }
          </button>
        </div>
      }
    </section>

    <!-- Bulk Transition Section -->
    <section class="card">
      <h2>Bulk Transition</h2>
      <p class="description">Apply the same transition to multiple issues at once.</p>

      <div class="form-grid">
        <div class="form-group full-width">
          <label for="bulkIssueKeys">Issue Keys (comma-separated)</label>
          <input
            type="text"
            id="bulkIssueKeys"
            placeholder="e.g., PROJ-1, PROJ-2, PROJ-3"
            [ngModel]="bulkIssueKeys()"
            (ngModelChange)="bulkIssueKeys.set($event)"
          />
        </div>

        <div class="form-group">
          <label for="bulkTransitionId">Transition ID</label>
          <input
            type="text"
            id="bulkTransitionId"
            placeholder="e.g., 21"
            [ngModel]="bulkTransitionId()"
            (ngModelChange)="bulkTransitionId.set($event)"
          />
        </div>
      </div>

      <button
        class="btn primary"
        [disabled]="bulkTransitioning() || !bulkIssueKeys() || !bulkTransitionId()"
        (click)="bulkTransition()"
      >
        @if (bulkTransitioning()) {
          Processing...
        } @else {
          Apply Bulk Transition
        }
      </button>

      @if (bulkResults().length > 0) {
        <div class="results">
          <h4>Results:</h4>
          <table class="results-table">
            <thead>
              <tr>
                <th>Issue</th>
                <th>Status</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody>
              @for (result of bulkResults(); track result.issueKey) {
                <tr [class.success]="result.success" [class.error]="!result.success">
                  <td>{{ result.issueKey }}</td>
                  <td>{{ result.success ? 'Success' : 'Failed' }}</td>
                  <td>{{ result.error || '-' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </section>
  }
</div>
