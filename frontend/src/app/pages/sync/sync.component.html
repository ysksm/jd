<div class="sync">
  <h2>Sync</h2>

  @if (loading()) {
    <p class="loading">Loading projects...</p>
  } @else {
    @if (error()) {
      <div class="alert alert-error">{{ error() }}</div>
    }

    <div class="sync-controls">
      <div class="project-selector">
        <label>Sync Target:</label>
        <select [ngModel]="selectedProject()" (ngModelChange)="selectProject($event)">
          <option [ngValue]="null">All Enabled Projects</option>
          @for (project of enabledProjects; track project.key) {
            <option [value]="project.key">{{ project.key }} - {{ project.name }}</option>
          }
        </select>
      </div>

      <div class="sync-options">
        <label class="checkbox-label">
          <input
            type="checkbox"
            [checked]="forceFullSync()"
            (change)="toggleForceSync()"
          />
          <span>Force Full Sync</span>
          <span class="hint">(Ignore last sync time, re-fetch all issues)</span>
        </label>
      </div>

      <button
        class="btn btn-primary"
        (click)="startSync()"
        [disabled]="syncing() || enabledProjects.length === 0"
      >
        @if (syncing()) {
          <span class="spinner"></span> Syncing...
        } @else if (forceFullSync()) {
          Force Full Sync
        } @else {
          Start Sync
        }
      </button>
    </div>

    @if (enabledProjects.length === 0) {
      <div class="alert alert-warning">
        No projects enabled for sync. Enable projects in the Projects page first.
      </div>
    }

    <!-- Sync Progress -->
    @if (syncing() && currentProgress()) {
      <div class="sync-progress">
        <h3>Sync Progress</h3>
        <div class="progress-card">
          <div class="progress-header">
            <span class="project-key">{{ currentProgress()!.projectKey }}</span>
            <span class="phase-label">{{ getPhaseLabel(currentProgress()!.phase) }}</span>
          </div>
          @if (currentProgress()!.total > 0) {
            <div class="progress-bar-container">
              <div
                class="progress-bar"
                [style.width.%]="(currentProgress()!.current / currentProgress()!.total) * 100"
              ></div>
            </div>
            <div class="progress-stats">
              <span class="progress-count">{{ currentProgress()!.current }} / {{ currentProgress()!.total }}</span>
              <span class="progress-percent">{{ ((currentProgress()!.current / currentProgress()!.total) * 100).toFixed(0) }}%</span>
            </div>
          }
          <div class="progress-message">{{ currentProgress()!.message }}</div>
        </div>

        <!-- Progress History Log -->
        @if (progressHistory().length > 0) {
          <div class="progress-log">
            <details>
              <summary>Progress Log ({{ progressHistory().length }} events)</summary>
              <div class="log-entries">
                @for (entry of progressHistory(); track $index) {
                  <div class="log-entry">
                    <span class="log-project">{{ entry.projectKey }}</span>
                    <span class="log-phase">{{ getPhaseLabel(entry.phase) }}</span>
                    <span class="log-message">{{ entry.message }}</span>
                  </div>
                }
              </div>
            </details>
          </div>
        }
      </div>
    }

    <!-- Project Status -->
    <div class="project-status">
      <h3>Enabled Projects</h3>
      @if (enabledProjects.length > 0) {
        <div class="status-grid">
          @for (project of enabledProjects; track project.key) {
            <div class="status-card">
              <div class="project-key">{{ project.key }}</div>
              <div class="project-name">{{ project.name }}</div>
              <div class="last-synced">
                Last synced: {{ formatDate(project.lastSyncedAt) }}
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Sync Results -->
    @if (syncResults().length > 0) {
      <div class="sync-results">
        <h3>Sync Results</h3>
        <div class="results-grid">
          @for (result of syncResults(); track result.projectKey) {
            <div class="result-card" [class.success]="result.success" [class.error]="!result.success">
              <div class="result-header">
                <span class="project-key">{{ result.projectKey }}</span>
                <span class="status-badge" [class.success]="result.success" [class.error]="!result.success">
                  {{ result.success ? 'Success' : 'Failed' }}
                </span>
              </div>
              @if (result.success) {
                <div class="result-stats">
                  <div class="stat">
                    <span class="label">Issues:</span>
                    <span class="value">{{ result.issueCount }}</span>
                  </div>
                  <div class="stat">
                    <span class="label">Duration:</span>
                    <span class="value">{{ formatDuration(result.duration) }}</span>
                  </div>
                  <div class="stat">
                    <span class="label">Metadata:</span>
                    <span class="value">{{ result.metadataUpdated ? 'Updated' : 'Unchanged' }}</span>
                  </div>
                </div>
              } @else {
                <div class="error-message">{{ result.error }}</div>
              }
            </div>
          }
        </div>
      </div>
    }
  }
</div>
