<div class="issues">
  <div class="issues-header">
    <h2>Issues</h2>
    <div class="view-controls">
      <div class="view-toggle">
        <button
          class="view-btn"
          [class.active]="viewMode() === 'list'"
          (click)="setViewMode('list')"
          title="List View"
        >
          <span class="icon-list"></span>
        </button>
        <button
          class="view-btn"
          [class.active]="viewMode() === 'board'"
          (click)="setViewMode('board')"
          title="Board View"
        >
          <span class="icon-board"></span>
        </button>
        <button
          class="view-btn"
          [class.active]="viewMode() === 'mindmap'"
          (click)="setViewMode('mindmap')"
          title="Mindmap View"
        >
          <span class="icon-mindmap"></span>
        </button>
        <button
          class="view-btn"
          [class.active]="viewMode() === 'calendar'"
          (click)="setViewMode('calendar')"
          title="Calendar View"
        >
          <span class="icon-calendar"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <div class="search-input">
      <input
        type="text"
        placeholder="Search issues..."
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)"
        (keypress)="onSearchKeypress($event)"
      />
      <button class="btn btn-primary" (click)="search()" [disabled]="loading()">
        Search
      </button>
    </div>

    <div class="filters">
      @if (!hasFixedProject) {
        <select
          [ngModel]="projectFilter()"
          (ngModelChange)="projectFilter.set($event); onProjectChange()"
        >
          <option value="">All Projects</option>
          @for (project of projects(); track project.key) {
            <option [value]="project.key">{{ project.key }} - {{ project.name }}</option>
          }
        </select>
      }

      <select
        [ngModel]="statusFilter()"
        (ngModelChange)="statusFilter.set($event); search()"
      >
        <option value="">All Statuses</option>
        @for (status of statuses(); track status.name) {
          <option [value]="status.name">{{ status.name }}</option>
        }
      </select>

      <select
        [ngModel]="issueTypeFilter()"
        (ngModelChange)="issueTypeFilter.set($event); search()"
      >
        <option value="">All Types</option>
        @for (type of issueTypes(); track type.name) {
          <option [value]="type.name">{{ type.name }}</option>
        }
      </select>

      <select
        [ngModel]="assigneeFilter()"
        (ngModelChange)="assigneeFilter.set($event); search()"
      >
        <option value="">All Assignees</option>
        @for (assignee of assignees(); track assignee) {
          <option [value]="assignee">{{ assignee }}</option>
        }
      </select>

      <select
        [ngModel]="teamFilter()"
        (ngModelChange)="teamFilter.set($event); search()"
      >
        <option value="">All Teams</option>
        @for (team of teams(); track team) {
          <option [value]="team">{{ team }}</option>
        }
      </select>

      <button class="btn btn-secondary" (click)="clearFilters()">Clear</button>
    </div>
  </div>

  <!-- Board Controls (shown when board view is active) -->
  @if (viewMode() === 'board') {
    <div class="board-controls">
      <div class="group-by">
        <label>Group by:</label>
        <select
          [ngModel]="groupBy()"
          (ngModelChange)="setGroupBy($event)"
        >
          <option value="none">None</option>
          <option value="assignee">Assignee</option>
          <option value="epic">Epic</option>
        </select>
      </div>
      @if (groupBy() !== 'none') {
        <div class="swimlane-controls">
          <button class="btn btn-secondary btn-sm" (click)="expandAllSwimlanes()" title="すべて開く">
            <span class="icon-expand"></span>
            開く
          </button>
          <button class="btn btn-secondary btn-sm" (click)="collapseAllSwimlanes()" title="すべて閉じる">
            <span class="icon-collapse"></span>
            閉じる
          </button>
        </div>
      }
    </div>
  }

  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="loading">Searching...</div>
  } @else {
    <div class="results-count">{{ total() }} issues found</div>

    @if (issues().length === 0) {
      <div class="empty-state">
        <p>No issues found.</p>
        <p>Try adjusting your search filters.</p>
      </div>
    } @else if (viewMode() === 'calendar') {
      <!-- Calendar View -->
      <app-calendar
        [issues]="issues()"
        (issueClick)="selectIssue($event)"
      ></app-calendar>
    } @else if (viewMode() === 'mindmap') {
      <!-- Mindmap View -->
      <app-mindmap
        [issues]="issues()"
        (issueClick)="selectIssue($event)"
      ></app-mindmap>
    } @else if (viewMode() === 'list') {
      <!-- List View -->
      <div class="issue-list">
        <div class="issue-header">
          <div class="header-key">Key</div>
          <div class="header-type">Type</div>
          <div class="header-summary">Summary</div>
          <div class="header-status">Status</div>
          <div class="header-priority">Priority</div>
          <div class="header-due-date">Due Date</div>
          <div class="header-assignee">Assignee</div>
        </div>
        @for (issue of issues(); track issue.key) {
          <div class="issue-row" (click)="selectIssue(issue)">
            <div class="issue-key">
              {{ issue.key }}
              <button
                class="jira-link-btn"
                (click)="openJiraLink($event, issue.key)"
                title="JIRAで開く"
              >
                <span class="icon-external-link"></span>
              </button>
            </div>
            <div class="issue-type" [attr.data-type]="issue.issueType.toLowerCase()">
              {{ issue.issueType }}
            </div>
            <div class="issue-summary">{{ issue.summary }}</div>
            <div class="issue-status" [attr.data-status]="issue.status.toLowerCase()">
              {{ issue.status }}
            </div>
            <div class="issue-priority">{{ issue.priority }}</div>
            <div class="issue-due-date" [class.overdue]="isOverdue(issue)" [class.due-soon]="isDueSoon(issue)">
              @if (issue.dueDate) {
                {{ formatDueDate(issue.dueDate) }}
              } @else {
                -
              }
            </div>
            <div class="issue-assignee">{{ issue.assignee || '-' }}</div>
          </div>
        }
      </div>
    } @else {
      <!-- Board View with Swimlanes -->
      <div class="board-view" [class.grouped]="groupBy() !== 'none'">
        <!-- Status Header Row (shown when grouping is enabled) -->
        @if (groupBy() !== 'none') {
          <div class="board-header">
            <div class="swimlane-label-header"></div>
            <div class="status-columns-wrapper">
              @for (status of statusNames(); track status) {
                <div class="status-header">{{ status }}</div>
              }
            </div>
          </div>
        }

        <!-- Swimlanes -->
        @for (swimlane of swimlanes(); track swimlane.name) {
          <div class="swimlane" [class.collapsed]="isSwimlaneCollapsed(swimlane.name)">
            <div class="swimlane-row">
              <!-- Swimlane Label (left side, only when grouping) -->
              @if (swimlane.name) {
                <div class="swimlane-label" (click)="toggleSwimlane(swimlane.name)">
                  <span class="swimlane-toggle">
                    @if (isSwimlaneCollapsed(swimlane.name)) {
                      <span class="icon-chevron-right"></span>
                    } @else {
                      <span class="icon-chevron-down"></span>
                    }
                  </span>
                  <span class="swimlane-title">{{ swimlane.name }}</span>
                  <span class="swimlane-count">{{ swimlane.issueCount }}</span>
                </div>
              }

              <!-- Status Columns -->
              @if (!isSwimlaneCollapsed(swimlane.name)) {
                <div class="status-columns-wrapper">
                  @for (column of swimlane.columns; track column.status) {
                    <div class="board-column" [attr.data-category]="column.category.toLowerCase()">
                      <!-- Show column header only when no grouping -->
                      @if (groupBy() === 'none') {
                        <div class="column-header">
                          <span class="column-title">{{ column.status }}</span>
                          <span class="column-count">{{ column.issues.length }}</span>
                        </div>
                      }
                      <div class="column-content">
                        @for (issue of column.issues; track issue.key) {
                          <div class="board-card" (click)="selectIssue(issue)">
                            <div class="card-header">
                              <span class="card-key">
                                {{ issue.key }}
                                <button
                                  class="jira-link-btn jira-link-btn-sm"
                                  (click)="openJiraLink($event, issue.key)"
                                  title="JIRAで開く"
                                >
                                  <span class="icon-external-link"></span>
                                </button>
                              </span>
                              <span class="card-type" [attr.data-type]="issue.issueType.toLowerCase()">
                                {{ issue.issueType }}
                              </span>
                            </div>
                            <div class="card-summary">{{ issue.summary }}</div>
                            @if (issue.dueDate) {
                              <div class="card-due-date" [class.overdue]="isOverdue(issue)" [class.due-soon]="isDueSoon(issue)">
                                <span class="icon-calendar-sm"></span>
                                {{ formatDueDate(issue.dueDate) }}
                              </div>
                            }
                            <div class="card-footer">
                              <span class="card-status" [attr.data-status]="issue.status.toLowerCase()">
                                {{ issue.status }}
                              </span>
                              @if (issue.assignee) {
                                <span class="card-assignee" title="{{ issue.assignee }}">
                                  {{ issue.assignee.charAt(0).toUpperCase() }}
                                </span>
                              }
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  }

  <!-- Issue Detail Modal -->
  @if (selectedIssue()) {
    <div class="modal-overlay" (click)="closeDetail()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            {{ selectedIssue()!.key }}
            <button
              class="jira-link-btn"
              (click)="openJiraLink($event, selectedIssue()!.key)"
              title="JIRAで開く"
            >
              <span class="icon-external-link"></span>
            </button>
          </h3>
          <button class="close-btn" (click)="closeDetail()">&times;</button>
        </div>
        <div class="modal-body">
          <h4>{{ selectedIssue()!.summary }}</h4>

          <div class="detail-grid">
            <div class="detail-row">
              <span class="label">Status:</span>
              <span class="value">{{ selectedIssue()!.status }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Priority:</span>
              <span class="value">{{ selectedIssue()!.priority }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Type:</span>
              <span class="value">{{ selectedIssue()!.issueType }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Assignee:</span>
              <span class="value">{{ selectedIssue()!.assignee || 'Unassigned' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Reporter:</span>
              <span class="value">{{ selectedIssue()!.reporter || '-' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Due Date:</span>
              <span class="value" [class.overdue]="isOverdue(selectedIssue()!)" [class.due-soon]="isDueSoon(selectedIssue()!)">
                @if (selectedIssue()!.dueDate) {
                  {{ formatDueDate(selectedIssue()!.dueDate) }}
                } @else {
                  -
                }
              </span>
            </div>
            <div class="detail-row">
              <span class="label">Created:</span>
              <span class="value">{{ selectedIssue()!.createdAt }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Updated:</span>
              <span class="value">{{ selectedIssue()!.updatedAt }}</span>
            </div>
          </div>

          @if (selectedIssue()!.description) {
            <div class="description">
              <h5>Description</h5>
              <p>{{ selectedIssue()!.description }}</p>
            </div>
          }

          @if (selectedIssue()!.labels.length > 0) {
            <div class="labels">
              <span class="label">Labels:</span>
              @for (label of selectedIssue()!.labels; track label) {
                <span class="tag">{{ label }}</span>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
