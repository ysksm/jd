<div class="settings">
  <h2>Settings</h2>

  @if (loading()) {
    <div class="loading">Loading settings...</div>
  } @else {
    @if (error()) {
      <div class="alert alert-error">{{ error() }}</div>
    }

    @if (success()) {
      <div class="alert alert-success">{{ success() }}</div>
    }

    <form class="settings-form">
      <!-- JIRA Endpoints -->
      <section class="settings-section">
        <h3>JIRA Endpoints</h3>

        @if (endpoints().length > 0) {
          <div class="endpoints-list">
            <div class="form-group">
              <label for="endpointSelect">Active Endpoint</label>
              <div class="endpoint-selector">
                <select
                  id="endpointSelect"
                  name="endpointSelect"
                  [ngModel]="activeEndpoint()"
                  (ngModelChange)="selectEndpoint($event)"
                >
                  @for (ep of endpoints(); track ep.name) {
                    <option [value]="ep.name">
                      {{ getEndpointDisplayName(ep) }} ({{ ep.endpoint }})
                    </option>
                  }
                </select>
                @if (endpoints().length > 1 && activeEndpoint() !== activeEndpoint()) {
                  <button
                    type="button"
                    class="btn btn-sm btn-secondary"
                    (click)="setActiveEndpoint(activeEndpoint()!)"
                    [disabled]="saving()"
                  >
                    Set as Default
                  </button>
                }
              </div>
            </div>

            <div class="endpoint-actions">
              @if (!showAddEndpoint()) {
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  (click)="showAddEndpoint.set(true)"
                >
                  + Add Endpoint
                </button>
              }
              @if (endpoints().length > 1) {
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  (click)="removeEndpoint(activeEndpoint()!)"
                  [disabled]="saving()"
                >
                  Remove Current
                </button>
              }
            </div>
          </div>

          @if (showAddEndpoint()) {
            <div class="add-endpoint-form">
              <h4>Add New Endpoint</h4>
              <div class="form-group">
                <label for="newEndpointName">Endpoint Name (ID) *</label>
                <input
                  type="text"
                  id="newEndpointName"
                  name="newEndpointName"
                  [ngModel]="newEndpointName()"
                  (ngModelChange)="newEndpointName.set($event)"
                  placeholder="e.g., production, staging"
                />
              </div>
              <div class="form-group">
                <label for="newEndpointDisplayName">Display Name (optional)</label>
                <input
                  type="text"
                  id="newEndpointDisplayName"
                  name="newEndpointDisplayName"
                  [ngModel]="newEndpointDisplayName()"
                  (ngModelChange)="newEndpointDisplayName.set($event)"
                  placeholder="e.g., Production Server"
                />
              </div>
              <div class="form-group">
                <label for="newEndpointUrl">Endpoint URL *</label>
                <input
                  type="url"
                  id="newEndpointUrl"
                  name="newEndpointUrl"
                  [ngModel]="newEndpointUrl()"
                  (ngModelChange)="newEndpointUrl.set($event)"
                  placeholder="https://your-domain.atlassian.net"
                />
              </div>
              <div class="form-group">
                <label for="newEndpointUsername">Username / Email *</label>
                <input
                  type="email"
                  id="newEndpointUsername"
                  name="newEndpointUsername"
                  [ngModel]="newEndpointUsername()"
                  (ngModelChange)="newEndpointUsername.set($event)"
                  placeholder="user@example.com"
                />
              </div>
              <div class="form-group">
                <label for="newEndpointApiKey">API Key *</label>
                <input
                  type="password"
                  id="newEndpointApiKey"
                  name="newEndpointApiKey"
                  [ngModel]="newEndpointApiKey()"
                  (ngModelChange)="newEndpointApiKey.set($event)"
                  placeholder="Enter your JIRA API key"
                />
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="addEndpoint()"
                  [disabled]="saving()"
                >
                  Add Endpoint
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="resetNewEndpointForm()"
                  [disabled]="saving()"
                >
                  Cancel
                </button>
              </div>
            </div>
          }
        }

        <div class="form-group">
          <label for="endpoint">Endpoint URL</label>
          <input
            type="url"
            id="endpoint"
            name="endpoint"
            [ngModel]="jiraEndpoint()"
            (ngModelChange)="jiraEndpoint.set($event)"
            placeholder="https://your-domain.atlassian.net"
          />
        </div>

        <div class="form-group">
          <label for="username">Username / Email</label>
          <input
            type="email"
            id="username"
            name="username"
            [ngModel]="jiraUsername()"
            (ngModelChange)="jiraUsername.set($event)"
            placeholder="user@example.com"
          />
        </div>

        <div class="form-group">
          <label for="apiKey">API Key</label>
          <input
            type="password"
            id="apiKey"
            name="apiKey"
            [ngModel]="jiraApiKey()"
            (ngModelChange)="jiraApiKey.set($event)"
            placeholder="Enter your JIRA API key"
          />
        </div>
      </section>

      <!-- Database Configuration -->
      <section class="settings-section">
        <h3>Database</h3>

        <div class="form-group">
          <label for="databasePath">Database Path</label>
          <input
            type="text"
            id="databasePath"
            name="databasePath"
            [ngModel]="databasePath()"
            (ngModelChange)="databasePath.set($event)"
            placeholder="./data/jira.duckdb"
          />
        </div>
      </section>

      <!-- Embeddings Configuration -->
      <section class="settings-section">
        <h3>Embeddings (Optional)</h3>

        <div class="form-group">
          <label for="provider">Provider</label>
          <select
            id="provider"
            name="provider"
            [ngModel]="embeddingsProvider()"
            (ngModelChange)="embeddingsProvider.set($event)"
          >
            <option value="openai">OpenAI</option>
            <option value="ollama">Ollama (Local)</option>
            <option value="cohere">Cohere</option>
          </select>
        </div>

        <div class="form-group">
          <label for="model">Model</label>
          <input
            type="text"
            id="model"
            name="model"
            [ngModel]="embeddingsModel()"
            (ngModelChange)="embeddingsModel.set($event)"
            placeholder="text-embedding-3-small"
          />
        </div>

        @if (embeddingsProvider() === 'ollama') {
          <div class="form-group">
            <label for="embeddingsEndpoint">Endpoint URL</label>
            <input
              type="url"
              id="embeddingsEndpoint"
              name="embeddingsEndpoint"
              [ngModel]="embeddingsEndpoint()"
              (ngModelChange)="embeddingsEndpoint.set($event)"
              placeholder="http://localhost:11434"
            />
          </div>
        }

        <div class="form-group checkbox">
          <label>
            <input
              type="checkbox"
              name="autoGenerate"
              [ngModel]="embeddingsAutoGenerate()"
              (ngModelChange)="embeddingsAutoGenerate.set($event)"
            />
            Auto-generate embeddings during sync
          </label>
        </div>
      </section>

      <!-- Log Configuration -->
      <section class="settings-section">
        <h3>Logging</h3>

        <div class="form-group checkbox">
          <label>
            <input
              type="checkbox"
              name="logFileEnabled"
              [ngModel]="logFileEnabled()"
              (ngModelChange)="logFileEnabled.set($event)"
            />
            Enable file logging
          </label>
        </div>

        @if (logFileEnabled()) {
          <div class="form-group">
            <label for="logFileDir">Log Directory (optional)</label>
            <input
              type="text"
              id="logFileDir"
              name="logFileDir"
              [ngModel]="logFileDir()"
              (ngModelChange)="logFileDir.set($event)"
              placeholder="Default: data/logs"
            />
          </div>

          <div class="form-group">
            <label for="logLevel">Log Level</label>
            <select
              id="logLevel"
              name="logLevel"
              [ngModel]="logLevel()"
              (ngModelChange)="logLevel.set($event)"
            >
              <option value="error">Error</option>
              <option value="warn">Warn</option>
              <option value="info">Info</option>
              <option value="debug">Debug</option>
              <option value="trace">Trace</option>
            </select>
          </div>

          <div class="form-group">
            <label for="logMaxFiles">Max Log Files</label>
            <input
              type="number"
              id="logMaxFiles"
              name="logMaxFiles"
              [ngModel]="logMaxFiles()"
              (ngModelChange)="logMaxFiles.set($event)"
              min="0"
              placeholder="10"
            />
            <small class="form-hint">0 = unlimited</small>
          </div>
        }
      </section>

      <!-- Sync Configuration -->
      <section class="settings-section">
        <h3>Sync Settings</h3>

        <div class="form-group checkbox">
          <label>
            <input
              type="checkbox"
              name="syncIncrementalEnabled"
              [ngModel]="syncIncrementalEnabled()"
              (ngModelChange)="syncIncrementalEnabled.set($event)"
            />
            Enable incremental sync (only fetch updated issues)
          </label>
          <small class="form-hint">When enabled, sync only fetches issues updated since the last sync.</small>
        </div>

        @if (syncIncrementalEnabled()) {
          <div class="form-group">
            <label for="syncMarginMinutes">Safety Margin (minutes)</label>
            <input
              type="number"
              id="syncMarginMinutes"
              name="syncMarginMinutes"
              [ngModel]="syncMarginMinutes()"
              (ngModelChange)="syncMarginMinutes.set($event)"
              min="0"
              max="60"
              placeholder="5"
            />
            <small class="form-hint">
              JQL only supports minute-level precision. This margin prevents data loss by fetching
              issues from a few minutes before the last sync time.
            </small>
          </div>
        }
      </section>

      <!-- Actions -->
      <div class="form-actions">
        @if (!initialized()) {
          <button
            type="button"
            class="btn btn-primary"
            (click)="initializeSettings()"
            [disabled]="saving()"
          >
            {{ saving() ? 'Initializing...' : 'Initialize Settings' }}
          </button>
        } @else {
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveSettings()"
            [disabled]="saving()"
          >
            {{ saving() ? 'Saving...' : 'Save Settings' }}
          </button>
        }
      </div>
    </form>
  }
</div>
